/*
 Copyright 2013 4pda.ru -QwertY-
 Use only on 4pda.ru
*/
(function(d,r,p,z,g){var A=function(b){return"undefined"===typeof b},u=function(b){return"function"===typeof b},w=function(b){return b instanceof Array},x=function(b){return"object"===typeof b||b instanceof Object},B=function(b){if(r.querySelectorAll)b=r.querySelectorAll(b);else{var a=void 0,c=void 0,f=void 0,d=void 0,q=void 0,q=r.createStyleSheet(),d=r.all,a=[];b=b.replace(/\[for\b/gi,"[htmlFor").split(",");for(c=b.length;c--;){q.addRule(b[c],"k:v");for(f=d.length;f--;)d[f].currentStyle.k&&a.push(d[f]);
q.removeRule(0)}b=a}return b},k=function(b,a){return d.setTimeout(b,a)},n=function(b){try{d.clearTimeout(b)}catch(a){}},h=B("script"),s=(h=h.length?h[h.length-1]:!1)&&h.src?h.src:!1,v=function(){for(var b=function(){try{return z.href+""}catch(f){var b=r.createElement("a");b.href="";return b.href+""}},a=["toString","get","set","toLocalString"],c=0;c<a.length;c++)b[a[c]]=function(){return b()};return b.prototype=b}(),t=-1<(v+"").indexOf("&debug=1"),l=d.navigator,h=l.appVersion,l=l.userAgent,N=h&&-1<
h.indexOf("Opera Mini")||l&&-1<l.indexOf("Opera Mini"),T=!/^(?:http:|https:)\//.test(v+""),U=function(){var b=0,a=function(f){f=f||d.event;if(f.isFixed)return f;f.isFixed=1;f.preventDefault=f.preventDefault||function(){this.returnValue=!1};f.stopPropagation=f.stopPropagation||function(){this.cancelBubble=!0};!f.target&&(f.target=f.srcElement);!f.relatedTarget&&event.fromElement&&(f.relatedTarget=f.fromElement==f.target?f.toElement:f.fromElement);if(null==f.pageX&&null!=f.clientX){var b=r.documentElement,
a=r.body;f.pageX=f.clientX+(b&&b.scrollLeft||a&&a.scrollLeft||0)-(b.clientLeft||0);f.pageY=f.clientY+(b&&b.scrollTop||a&&a.scrollTop||0)-(b.clientTop||0)}!f.which&&f.button&&(f.which=f.button&1?1:f.button&2?3:f.button&4?2:0);return f},c=function(b){b=a(b);var c=this.events[b.type],d;for(i in c)d=c[i],d=d.call(this,b),!1===d&&(b.preventDefault(),b.stopPropagation())};return{add:function(a,g,F){a.setInterval&&a!=d&&!a.frameElement&&(a=d);F.guid||(F.guid=++b);a.events||(a.events=[],a.handle=function(b){if(!A(b))return c.call(a,
b)});a.events[g]||(a.events[g]={},a.addEventListener?a.addEventListener(g,a.handle,!1):a.attachEvent&&a.attachEvent("on"+g,a.handle));a.events[g][F.guid]=F},del:function(a,b,c){var d=a.events&&a.events[b],g;if(d){delete d[c.guid];for(g in d)return;a.removeEventListener?a.removeEventListener(b,a.handle,!1):a.detachEvent&&a.detachEvent("on"+b,a.handle);delete a.events[b];for(g in a.events)return;try{delete a.handle,delete a.events}catch(F){a.removeAttribute("handle"),a.removeAttribute("events")}}}}}(),
ha=function(a,c,d){e=(isa=w(a))?a[0]:a;for(i=0;e&&x(e);)U.add(e,c,d),i++,e=isa?a[i]:!1},h=function(a){var c=B("#consoleLogCustomElement")[0],d=(t?"":"display:none;")+"opacity:0.5;position:fixed;left:0;top:0;width:100%;height:10em;color:#000;background:#FFF;overflow:auto;z-index:99999;opacity:0.5;";if(c)return c.c;r.write("<pre id='consoleLogCustomElement'></pre>");a=r.createElement("style");B("head")[0].appendChild(a);a=a.sheet?a.sheet:a.styleSheet;a.insertRule?(a.insertRule("#consoleLogCustomElement{"+
d+"}",0),a.insertRule("#consoleLogCustomElement:hover{opacity:1;}",1)):(a.addRule("#consoleLogCustomElement",d,0),a.addRule("#consoleLogCustomElement:hover","opacity:1;",1));c=B("#consoleLogCustomElement")[0];c.c=this;t&&(p.log=function(a){c.innerHTML+=a+"\n";try{c.scrollTop=c.scrollHeight}catch(b){}})};x(p)||(p=d.console={});u(p.log)&&!t||h();h=function(){return null};"localStorage"in d||(d.localStorage={getItem:h,setItem:h,removeItem:h});var a=0,c,h=function(){var b={WS:g,XHR:g},F="WebSocket"in
d,h=function(m){var a;"XMLHttpRequest"in d||(d.XMLHttpRequest=function(){try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(m){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(a){}try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(b){}throw Error("This browser does not supportXMLHttpRequest");});a=d.XMLHttpRequest;m&&"XDomainRequest"in d&&(a=d.XDomainRequest);return new a},f=function(m,a,b,c){if(!m||m.inWork)return m;if(A(c)||isNaN(parseInt(c)))c=30;"timeoutTimer"in m||(m.timeoutTimer=
g,m.prevSend=m.send,m.send=function(m){var a=this;a.prevSend(m);a.timeoutTimer||(n(a.timeoutTimer),a.timeoutTimer=g,a.timeout&&(a.timeoutTimer=k(function(){if(a.timeoutTimer&&a&&(n(a.timeoutTimer),a.timeoutTimer=g,u(a.ontimeout)))a.ontimeout({bubbles:!1,cancelBubble:!1,currentTarget:a,defaultPrevented:!1,eventPhase:1,isTrusted:!1,srcElement:a,target:a,timeStamp:(new Date).getTime(),type:"timeout"})},a.timeout)))});n(m.timeoutTimer);m.timeout=1E3*c;m.onerror=m.onabort=m.ontimeout=function(){n(this.timeoutTimer);
u(b)&&b()};"onreadystatechange"in m?m.onreadystatechange=function(){var c,d;try{4==m.readyState&&200==m.status&&(c=1)}catch(g){d=1}d?(n(this.timeoutTimer),u(b)&&b()):c&&(n(this.timeoutTimer),u(a)&&a())}:m.onload=function(){n(this.timeoutTimer);u(a)&&a()};return m},p=[],q=w(d.Events4PDA_markers)?d.Events4PDA_markers:[],t,l,z,I=function(){n(z);z=g},J,V=function(){n(J);J=g},K=0,H=function(){K=1;I();V();l=t=0;var a=[d,r],b=ia;e=(isa=w(a))?a[0]:a;for(i=0;e&&x(e);)U.del(e,"storage",b),i++,e=isa?a[i]:!1;
L=1;O();W=1;G();if(s){a=r.createElement("script");b=s.substr(-1);b=s+("&"===b||"?"===b?"":-1<s.indexOf("?")?"&":"?")+"time="+(new Date).getTime();with(a)type="text/javascript",src=b;B("head")[0].appendChild(a)}},ba,la=function(a){n(ba);ba=g;ba=k(function(){C("set_markers",q.join(","));a&&(b.WS?ja():ka())},500)},D={ver:function(){return 0.19},sver:function(){return c},markers:function(){return q.slice(0)},deinit:function(){H()},addCallback:function(a){-1==p.indexOf(a)&&p.push(a);return D},removeCallback:function(a){-1<
(ind=p.indexOf(a))&&p.splice(ind,1);return D},addMarker:function(a){a=w(a)?a:(a+"").split(",");var b,c=[];for(b=0;b<a.length;b++)a[b]&&""!==a[b]&&-1===q.indexOf(a[b])&&(c.push(a[b]),q.push(a[b]));l?la(c.length):c.length&&C("add_mark",c.join(","));return D},removeMarker:function(a){a=w(a)?a:(a+"").split(",");var b,c=[],d;for(b=0;b<a.length;b++)-1!==(d=q.indexOf(a[b]))&&(c.push(a[b]),q.splice(d,1));l?la(c):c.length&&C("del_mark",c.join(","));return D},clearMarkers:function(){q.length&&q.splice(0,q.length);
return D},XHR:h,XHRWrap:f,encStr:function(a){w(a)||(a=a.split("").map(function(a){return(a+"").charCodeAt(0)}));var b,c=a.length,d="",g;for(b=0;c>b;b++)g=a[b],128>g?d+=String.fromCharCode(g):127<g&&2048>g&&(d+=String.fromCharCode(g+848));return d}},sa=function(a){a&&a.length&&(a=(new Date).getTime()+","+v+","+a,localStorage.setItem("Events4PDA_msg",a),k(function(){localStorage.setItem("Events4PDA_msg",0)},1E3))},C=function(a,b){A(b)||!(b+"").length?b="":a+=",";sa(a+b)},X,ta=function(){l&&!X&&(X=k(function(){n(X);
X=g},100),C("pong",0.19))},ua=function(){K||(I(),K||(I(),l=t=1,C("request_markers"),O(),G(),F?ma():ca()))},na=function(){K||(I(),V(),O(),G(),l=t=0,z=k(ua,2E3+Math.round(1E3*Math.random())),C("ping",0.19))},da=function(){K||(I(),t=1,LS_Server=0,O(),G(),C("add_mark",q.join(",")),oa())},oa=function(){V();J=k(va,5E3+10*Math.round(50*Math.random()))},va=function(){V();C("ping",0.19);J=k(function(){n(J);J=g;k(na,10*Math.floor(100*Math.random())+100)},2E3)},P=0,Y=[],ia=function(b){if(!(K||P===b.newValue||
"Events4PDA_msg"!==b.key||0==b.newValue||(P=b.newValue,-1<Y.indexOf(P)))){50<Y.length&&Y.shift();Y.push(P);b=P.split(",");b.shift();b.shift();var c=b.shift();if(t)if(l)switch(c){case "pong":case "ping":if(!b.length)break;a=parseFloat(b[0]);if(0.19===a){if("pong"===c)return da();ta()}else 0.19<a&&H();break;case "clear_mark":D.clearMarkers();break;case "del_mark":D.delMarker(b);break;case "add_mark":D.addMarker(b);break;case "get_markers":C("set_markers",q.join(","));break;case "ev":b.length&&(a=parseFloat(b.shift()));
if(isNaN(a))break;if(b.length){if(0.19<a)return H();0.19==a&&(Z(b.shift(),b),da())}}else{switch(c){case "pong":if(!b.length)return;a=parseFloat(b[0]);0.19<a&&H();break;case "request_markers":C("add_mark",q.join(","));break;case "set_markers":D.clearMarkers();q=b.slice(0);break;case "ev":b.length&&(a=parseFloat(b.shift()));if(isNaN(a))return;if(0.19<a)return H();0.19==a&&Z(b.shift(),b)}oa()}else if(("ping"===c||"pong"===c)&&b.length){a=parseFloat(b[0]);if(0.19===a||"pong"===c)return I(),da();if(0.19<
a)return H()}}},Z=function(a,b){w(b)||(b=[]);if(l){var c=b.slice(0);c.unshift(a);C("ev,0.19",c)}for(c=0;c<p.length;c++)if(u(p[c]))p[c](a,b.join(","))},L,$,ma=function(){n($);$=g;if(!L&&!b.WS)try{b.WS=new WebSocket("ws://app.4pda.ru/w/");with(b.WS)onclose=wa,onerror=xa,onmessage=ya,onopen=za}catch(a){L=1,k(ca,1)}},O=function(){try{b.WS.close()}catch(a){}b.WS=g;try{delete b.WS}catch(c){}},ea=65536,Q={},aa,pa=function(){if(!A(b.WS)&&1===b.WS.readyState){var a=[],c,f;for(c in Q)f=Q[c],f.s?!f.c&&a.push(c):
(b.WS.send(f.q),f.s=1);for(c=0;c<a.length;c++)try{delete Q[a[c]]}catch(F){}try{d.clearInterval(aa)}catch(h){}aa=g}},qa=function(a,b){w(a)||(a=[a+""]);var c=a.slice(0),g,f;if(!L&&c.length&&c[0]&&""!=c[0]){for(g=0;g<c.length;g++)f=c[g],isNaN(f)&&(f='"'+f.replace("/([\"'])/g","\\$1").replace("/\x00/g","\\0")+'"'),c[g]=f;c.unshift(ea);c="["+c.join(",")+"]";Q[ea]={s:0,q:c,c:b};ea++;aa||(aa=d.setInterval(pa,500));pa()}},ja=function(){var a=q.slice(0);a.unshift("em");qa(a)},fa,Aa=function(){c=g;fa=k(function(){L=
1;O();ca()},3E3);qa(["sv"],function(a){a=a[0].split(".");c=[parseInt(a[0])+"."+parseInt(a[1]),parseInt(a[2])];c[1]+="."+parseInt(a[2].substr((c[1]+"").length),16);n(fa);fa=g;if(0.3>c[0]||0.12>c[1])return H();ja()})},wa=function(a){$||($=k(ma,1E3))},xa=function(a){},ya=function(a){if(a.data instanceof Blob){var b=new FileReader;b.onloadend=function(a){ra(D.encStr(new Uint8Array(a.target.result)))};b.readAsArrayBuffer(a.data)}else ra(a.data)},za=function(){Aa()},ra=function(a){var b;try{b=eval("("+
a+")")}catch(c){b=(a+"").replace(/^\[+|\]+$/g,"").split(",")}if(w(b)&&!isNaN(parseInt(b[0]))){a=parseInt(b.shift());var d=b.shift(),f;isNaN(parseInt(d))?(b.unshift(d),d=0):d=parseInt(d);65536>a?Z(b.shift(),b):(f=Q[a])&&f.c&&(d||u(f.c)&&f.c(b),f.c=g)}},W,M=function(a){A(a)?a=localStorage.getItem("Events4PDA_sid"):null===a?localStorage.removeItem("Events4PDA_sid"):localStorage.setItem("Events4PDA_sid",a);return a},ga=function(a,c){b.XHR=g;try{delete b.XHR}catch(d){}b.XHR=h(1);b.XHR.open(a,c)},ca=function(){if(!W){b.XHR=
g;try{delete b.XHR}catch(a){}L=1;R()}},G=function(){try{b.XHR.abort()}catch(a){}},E,R=function(){n(E);E=g;G();if(M())return ka();var a="http://app.4pda.ru/e/c/"+q.join(",");ga("GET",a);f(b.XHR,Ba,Ca,5);b.XHR.send(null)},Ba=function(){M(b.XHR.responseText);y||(y=k(S,1))},Ca=function(a){E||(E=k(R,A(a)?5E3:500))},ka=function(){W||(""===q.join(",")?y||(y=k(S,1)):(G(),ga("GET","http://app.4pda.ru/e/m/"+M()+"/"+q.join(",")),f(b.XHR,Da,Ea,5),b.XHR.send(null)))},Da=function(){"nosession"==b.XHR.responseText?
(M(null),E||(E=k(R,100))):y||(y=k(S,1))},Ea=function(a){E||(E=k(R,A(a)?5E3:500))},y,S=function(){n(y);y=g;W||(G(),ga("GET","http://app.4pda.ru/e/r/"+M()),f(b.XHR,Fa,Ga,120),b.XHR.send(null))},Fa=function(){if("nosession"==b.XHR.responseText)M(null),E||(E=k(R,100));else{if("timeout"!==b.XHR.responseText){var a,c=b.XHR.responseText.split("\n"),d;for(a=0;a<c.length;a++)d=c[a].replace(/\^s+|\s+$/g,"").split(","),d.length&&""!==d[0]&&Z(d.shift(),d)}y||(y=k(S,1))}},Ga=function(a){y||(y=k(S,A(a)?5E3:500))};
N||T||(ha([d,r],"storage",ia),na());return D};x(d.Events4PDA)&&d.Events4PDA.ver&&(a=d.Events4PDA.ver?u(d.Events4PDA.ver)?d.Events4PDA.ver():d.Events4PDA.ver:0);if(!(0.19<=a)){h.prototype=h;if(x(d.Events4PDA))try{delete d.Events4PDA,delete d.$4ev}catch(F){}d.Events4PDA=new h;d.$4ev=d.Events4PDA}})(window,document,window.console,location);var _eev_lang={messages:"\u0421\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0439: "};
function _events_engine(d,r){var p=document,z=function(a){return a instanceof Object},g=function(a){return window.Element?a instanceof Element:z(a)},A=function(a,c,d){g(a)&&(a.addEventListener?a.addEventListener(c,d,!1):a.attachEvent?a.attachEvent("on"+c,d):a["on"+c]=d);return a},u=function(a,c,d){try{a["class"==c?"className":c]=d}catch(b){}g(a)&&a.setAttribute("className"==c?"class":c,d);return a},w=function(a,c){if(g(a)&&z(c))for(var d in c)u(a,d,c[d]);return a},x=function(a,c){return g(a)?a.getAttribute(c):
null},B=function(a,c){return w(p.createElement(a),c)},k=function(a,c){g(c)&&g(a)&&c.appendChild(a);return a},n=function(a,c){g(a)&&(a.innerHTML=c);return a},h=p.getElementById("events_wrapper"),s=p.getElementById("events_list"),v=p.getElementById("events_count"),t=p.getElementById("events_count_val"),l=function(){var a=1;try{z($4ev)&&($4ev.addCallback(U).addMarker("u"+d),a=0)}catch(c){}a&&setTimeout(l,300)},N=function(){h.style.display=0==x(v,"count")?"none":"block"},T=function(a,c){var d=parseInt(x(a,
"unread"),10),d=isNaN(d)?1:d+1;w(a,{unread:d,style:"display:block"});n(a,"<a href='/forum/index.php?act=qms&mid="+c[0]+"&t="+c[1]+"' title='"+x(a,"title")+"' onclick=\"return popupNewQms(this);\" target='qms_"+c[1]+"'>"+x(a,"username")+" ("+d+")</a>");d=parseInt(x(v,"count"))+1;u(v,"count",d);n(t,d);N()},U=function(a,c){var h,b,l;c=c.split(",");switch(a){case "qms_newmsg":if(c[0]==d)break;h=p.getElementById("qms_unread_t"+c[1]+"_m"+c[0]);g(h)?T(h,c):(h=k(B("div",{id:"qms_unread_t"+c[1]+"_m"+c[0],
unread:0,u_id:c[0],t_id:c[1],"class":"qms_unread_row"}),s),b=$4ev.XHR(),b.open("GET","/forum/index.php?act=qms&get_thread_info=1&t="+c[1]+"&mid="+c[0]),$4ev.XHRWrap(b,function(){var a=null;try{a=eval("("+b.responseText+")")}catch(d){}z(a)&&(w(h,a),T(h,c,v,t))},function(){},30).send(null));break;case "qms_readmsg":h=p.getElementById("qms_unread_t"+c[1]+"_m"+c[0]);if(!g(h))break;h.style.display="none";l=x(h,"unread");u(h,"unread",0);l&&(l=x(v,"count")-l,0>l&&(l=0),u(v,"count",l),n(t,l),N())}};g(h)||
(h=k(B("div",{id:"events_wrapper"}),p.body));g(s)||(s=k(B("div",{id:"events_list"}),h));g(v)||(v=n(k(B("div",{id:"events_count",count:0}),h),_eev_lang.messages));g(t)||(t=n(k(B("span",{id:"events_count_val"}),v),0));try{z($4ev)&&l()}catch(ha){}A(v,"click",function(a){s.style.display="block"==s.style.display?"none":"block";a.preventDefault&&a.preventDefault();a.returnValue=!1;a.stopPrapagation&&a.stopPrapagation();return!1});A(h,"mouseout",function(){s.tmr&&window.clearTimeout(s.tmr);"none"!=s.style.display&&
(s.tmr=setTimeout(function(){s.style.display="none"},5E3))});N();return this}function popupNewQms(d){if(d){var r="number"==typeof window.devicePixelRatio?window.devicePixelRatio:1;window.open(d.href+"&small=1",d.target,"width="+480*r+"px,height="+600*r+"px,resizible=on");return!1}};
